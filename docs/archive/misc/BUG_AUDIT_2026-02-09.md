# üîç BUG AUDIT - PRE-LAUNCH STABILIZATION
**Date:** 2026-02-09 19:40 PST  
**Auditor:** Inspector (Antigravity AI)  
**Scope:** Existing functionality only - NO new features  
**Priority:** CRITICAL - Must fix before adding anything new

---

## üö® **CRITICAL BLOCKERS** (Must Fix Before Launch)

### **BLOCKER #1: Header Icons Not Working**
**Location:** `src/components/TopHeader.tsx` lines 137-178  
**Status:** ‚ùå **BROKEN**  
**Impact:** Users can't access core features

**Broken Icons:**
1. **Search Icon** (line 145-150)
   - Navigates to: `/advanced-search`
   - **Problem:** Page doesn't exist
   - **Error:** 404 Not Found

2. **Notifications Icon** (line 154-160)
   - Navigates to: `/notifications`
   - **Problem:** Page doesn't exist
   - **Error:** 404 Not Found

3. **Help Icon** (line 164-169)
   - Navigates to: `/help`
   - **Problem:** Page doesn't exist
   - **Error:** 404 Not Found

**Fix Required:**
```tsx
// Option A: Create missing pages
// - src/pages/AdvancedSearch.tsx
// - src/pages/Notifications.tsx
// - src/pages/Help.tsx

// Option B: Disable icons until pages exist
// - Comment out or hide non-functional icons
// - Add "Coming Soon" tooltip

// Option C: Redirect to existing pages
onClick={() => navigate('/search-portal')}  // For search
onClick={() => alert('Notifications coming soon')}  // Temporary
```

**Recommended:** Option B (disable until pages exist)

---

### **BLOCKER #2: Protocol Builder - Database Not Connected**
**Location:** `src/pages/ProtocolBuilder.tsx` lines 714-718  
**Status:** ‚ùå **BROKEN**  
**Impact:** Form submissions fail completely

**Problem:**
```tsx
const { data: newProtocol, error } = await supabase
  .from('protocols')  // ‚ùå TABLE DOES NOT EXIST
  .insert([protocolPayload])
```

**Error:** `relation "protocols" does not exist`

**Fix Required:**
1. Create `protocols` table migration
2. Map all form fields to proper columns
3. Test form submission

**Time to Fix:** 2 hours

---

### **BLOCKER #3: Logout Doesn't Work Properly**
**Location:** `src/components/TopHeader.tsx` line 228  
**Status:** ‚ö†Ô∏è **INCOMPLETE**  
**Impact:** Security vulnerability

**Current Code:**
```tsx
<button onClick={() => { onLogout(); setIsMenuOpen(false); }}>
  Sign Out of Node
</button>
```

**Problem:**
- `onLogout()` prop may not invalidate Supabase session
- User stays logged in after logout
- Session tokens remain valid

**Fix Required:**
```tsx
const handleLogout = async () => {
  await supabase.auth.signOut();
  localStorage.clear();
  sessionStorage.clear();
  navigate('/');
  setIsMenuOpen(false);
};
```

**Time to Fix:** 3 hours

---

## üü° **HIGH PRIORITY BUGS** (Fix Before Polish)

### **BUG #4: Constants vs Supabase Mismatch**
**Status:** ‚ö†Ô∏è **DATA INCONSISTENCY**  
**Impact:** Dropdowns don't match database

**Files Using Constants Instead of Supabase:**

| File | Constant Used | Should Use Supabase Table |
|------|---------------|---------------------------|
| `ProtocolBuilder.tsx` | `MEDICATIONS_LIST` | `ref_medications` (doesn't exist) |
| `ProtocolBuilder.tsx` | Hardcoded `SUBSTANCE_OPTIONS` | `ref_substances` |
| `ProtocolBuilder.tsx` | Hardcoded `ROUTE_OPTIONS` | `ref_routes` |
| `ProtocolBuilder.tsx` | Hardcoded `SAFETY_EVENT_OPTIONS` | `ref_safety_events` |
| `InteractionChecker.tsx` | `INTERACTION_RULES` | `ref_knowledge_graph` (doesn't exist) |
| `InteractionChecker.tsx` | `MEDICATIONS_LIST` | `ref_medications` (doesn't exist) |
| `SubstanceCatalog.tsx` | `SUBSTANCES` | `ref_substances` |
| `SubstanceMonograph.tsx` | `SUBSTANCES` | `ref_substances` |
| `SearchPortal.tsx` | `SUBSTANCES` | `ref_substances` |
| `SearchPortal.tsx` | `CLINICIANS` | Should query from auth/user_sites |
| `SearchPortal.tsx` | `PATIENTS` | Should query from log tables |

**Recommendation:**
‚úÖ **YES - Update constants to match Supabase reference tables**

**Action Plan:**
1. Audit all `ref_*` tables in Supabase
2. Compare with constants in `constants.ts`
3. Create migration to add missing ref tables
4. Update components to fetch from Supabase
5. Keep constants as fallback/seed data only

---

### **BUG #5: Missing Reference Tables**
**Status:** ‚ùå **SCHEMA INCOMPLETE**  
**Impact:** Can't properly validate data

**Tables That Should Exist (But Don't):**
- ‚ùå `ref_medications` - For medication dropdowns
- ‚ùå `ref_knowledge_graph` - For drug interactions
- ‚ùå `ref_dosage_units` - For dosage unit dropdowns
- ‚ùå `ref_settings` - For treatment setting dropdowns
- ‚ùå `ref_resolution_status` - For safety event resolution

**Tables That DO Exist:**
- ‚úÖ `ref_substances`
- ‚úÖ `ref_routes`
- ‚úÖ `ref_safety_events`
- ‚úÖ `ref_smoking_status`
- ‚úÖ `ref_support_modality`
- ‚úÖ `ref_severity_grade`

**Fix Required:**
Create migration to add missing ref tables and seed them from constants.ts

---

### **BUG #6: Protocol Builder Field Mapping Issues**
**Location:** `src/pages/ProtocolBuilder.tsx` lines 670-711  
**Status:** ‚ö†Ô∏è **INCOMPLETE MAPPING**  
**Impact:** Data loss on form submission

**Fields NOT Being Saved:**
- `subjectId` - Generated but not persisted
- `patientHash` - Generated but not persisted
- `resolutionStatus` - Exists in form but not in payload (line 482 vs 685)

**Fields Stored in JSONB (Anti-Pattern):**
- `dosing_schedule` - Should be proper columns
- `safety_criteria` - Should be proper columns
- `outcome_measures` - Should be proper columns
- `notes` - Should be proper columns

**Fix Required:**
1. Create proper table schema with real columns
2. Fix `resolutionStatus` bug (line 685 uses wrong field name)
3. Map all form fields correctly

---

## üü¢ **MEDIUM PRIORITY BUGS** (Fix During Polish)

### **BUG #7: Hardcoded User Data**
**Location:** `src/components/TopHeader.tsx` line 49  
**Status:** ‚ö†Ô∏è **MOCK DATA**  
**Impact:** Shows wrong user info

**Current Code:**
```tsx
const currentUser = CLINICIANS[0]; // Dr. Sarah Jenkins
```

**Problem:**
- Always shows "Dr. Sarah Jenkins"
- Doesn't reflect actual logged-in user
- Hardcoded from constants

**Fix Required:**
```tsx
const [currentUser, setCurrentUser] = useState(null);

useEffect(() => {
  const fetchUser = async () => {
    const { data: { user } } = await supabase.auth.getUser();
    if (user) {
      const { data } = await supabase
        .from('user_sites')
        .select('*, sites(*)')
        .eq('user_id', user.id)
        .single();
      setCurrentUser(data);
    }
  };
  fetchUser();
}, []);
```

---

### **BUG #8: Search Portal Uses Mock Data**
**Location:** `src/pages/SearchPortal.tsx` line 3  
**Status:** ‚ö†Ô∏è **MOCK DATA**  
**Impact:** Shows fake results

**Current Code:**
```tsx
import { SUBSTANCES, CLINICIANS, PATIENTS } from '../constants';
```

**Problem:**
- All search results are hardcoded
- Doesn't query real database
- Can't search actual protocols

**Fix Required:**
Replace constants with Supabase queries

---

### **BUG #9: Substance Catalog Uses Mock Data**
**Location:** `src/pages/SubstanceCatalog.tsx` line 10  
**Status:** ‚ö†Ô∏è **MOCK DATA**  
**Impact:** Shows fake substances

**Current Code:**
```tsx
import { SUBSTANCES, MEDICATIONS_LIST } from '../constants';
```

**Problem:**
- Hardcoded substance list
- Doesn't reflect actual ref_substances table

**Fix Required:**
```tsx
const [substances, setSubstances] = useState([]);

useEffect(() => {
  const fetchSubstances = async () => {
    const { data } = await supabase
      .from('ref_substances')
      .select('*')
      .order('substance_name');
    setSubstances(data || []);
  };
  fetchSubstances();
}, []);
```

---

## üìä **CONSTANTS vs SUPABASE SYNC PLAN**

### **Phase 1: Audit Reference Tables**
```sql
-- Run this query in Supabase to see what exists:
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_name LIKE 'ref_%'
ORDER BY table_name;
```

### **Phase 2: Create Missing Tables**
Priority order:
1. `ref_dosage_units` (CRITICAL - Protocol Builder needs this)
2. `ref_medications` (HIGH - Interaction Checker needs this)
3. `ref_settings` (MEDIUM - Protocol Builder uses this)
4. `ref_resolution_status` (MEDIUM - Safety events use this)
5. `ref_knowledge_graph` (LOW - Can use constants for now)

### **Phase 3: Seed Data from Constants**
```sql
-- Example: Seed ref_dosage_units from constants
INSERT INTO ref_dosage_units (unit_name, unit_abbreviation)
VALUES
  ('milligrams', 'mg'),
  ('micrograms', 'mcg (¬µg)'),
  ('milliliters', 'ml'),
  ('units', 'Units'),
  ('drops', 'Drops')
ON CONFLICT (unit_name) DO NOTHING;
```

### **Phase 4: Update Components**
Replace hardcoded constants with Supabase queries:
- ‚úÖ Keep constants.ts for seed data
- ‚úÖ Fetch from Supabase in components
- ‚úÖ Use constants as fallback if query fails

---

## üéØ **RECOMMENDED FIX ORDER**

### **Week 1: Critical Blockers** (11 hours)
1. **Day 1:** Fix header icons (3 hours)
   - Create missing pages OR disable icons
   - Test all navigation

2. **Day 2:** Create protocols table (2 hours)
   - Generate migration
   - Test Protocol Builder form

3. **Day 3:** Fix logout (3 hours)
   - Implement proper Supabase signOut
   - Test session invalidation

4. **Day 4:** Create missing ref tables (3 hours)
   - ref_dosage_units
   - ref_medications
   - ref_settings

### **Week 2: High Priority** (8 hours)
5. **Day 5:** Sync constants with Supabase (4 hours)
   - Seed ref tables from constants
   - Update Protocol Builder to use ref tables

6. **Day 6:** Fix field mapping bugs (4 hours)
   - Fix resolutionStatus bug
   - Test all form fields save correctly

### **Week 3: Medium Priority** (6 hours)
7. **Day 7:** Replace mock data with real queries (6 hours)
   - Update Search Portal
   - Update Substance Catalog
   - Update TopHeader user info

---

## ‚úÖ **SUCCESS CRITERIA**

**Before Launch, ALL of these must be TRUE:**
- [ ] All header icons work OR are disabled with tooltips
- [ ] Protocol Builder saves to database successfully
- [ ] Logout invalidates session completely
- [ ] All dropdowns pull from Supabase ref tables
- [ ] No 404 errors on any navigation
- [ ] No hardcoded user data (shows real logged-in user)
- [ ] Search Portal queries real database
- [ ] Substance Catalog queries real database

---

## üìù **NEXT STEPS**

**Immediate Actions (Today):**
1. Review this audit with team
2. Decide on header icon fix (disable vs create pages)
3. Prioritize which bugs to fix first

**This Week:**
1. Fix all CRITICAL BLOCKERS
2. Create missing ref tables
3. Sync constants with Supabase

**Next Week:**
1. Replace all mock data with real queries
2. Test end-to-end workflows
3. Launch readiness review

---

**Total Estimated Time to Fix All Bugs:** 25 hours  
**Minimum Time to Launch:** 11 hours (critical blockers only)  
**Recommended Time:** 19 hours (critical + high priority)
